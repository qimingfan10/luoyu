<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã€Šå•è¯ç–¯äººé™¢ã€‹- é£è¶£è®°å¿†å¤§å¸ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=ZCOOL+XiaoWei&family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #1a1a1a;
            color: #e0e0e0;
        }
        .font-brand {
            font-family: 'ZCOOL XiaoWei', serif;
        }
        .ai-bubble {
            background-color: #2c2c2c;
            border-left: 4px solid #8A2BE2;
            animation: fadeIn 0.5s ease-in-out;
        }
        .user-interaction {
            background-color: #252525;
            border: 1px solid #444;
            min-height: 150px;
            animation: slideInUp 0.5s ease-in-out;
        }
        .option-btn {
            transition: all 0.2s ease-in-out;
        }
        .option-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(138, 43, 226, 0.3);
        }
        .option-btn.correct {
            background-color: #28a745;
            border-color: #28a745;
            color: white;
        }
        .option-btn.incorrect {
            background-color: #dc3545;
            border-color: #dc3545;
            color: white;
        }
        .feedback {
            animation: fadeIn 0.3s ease-in-out;
        }
        #next-btn {
            background-color: #8A2BE2;
            transition: background-color 0.3s;
        }
        #next-btn:hover {
            background-color: #9932CC;
        }
        #next-btn:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideInUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #8A2BE2;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .gemini-badge {
            background: linear-gradient(45deg, #4285f4, #34a853, #fbbc05, #ea4335);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: bold;
        }
        .step-indicator {
            background: linear-gradient(45deg, #8A2BE2, #9932CC);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        .word-art {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            border: 2px solid #8A2BE2;
            border-radius: 8px;
            padding: 20px;
            white-space: pre-line;
            text-align: center;
            line-height: 1.2;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div id="app-container" class="w-full max-w-4xl mx-auto bg-[#1e1e1e] rounded-2xl shadow-2xl p-6 md:p-8 space-y-6">
        <header class="text-center">
            <h1 class="text-3xl md:text-4xl font-brand text-white">ã€Šå•è¯ç–¯äººé™¢ã€‹</h1>
            <p class="text-purple-300">èƒ½è®©ä½ ç¬‘å‡ºè…¹è‚Œçš„è‹±è¯­å•è¯è®°å¿†å¤§å¸ˆ</p>
            <p class="text-sm text-gray-400 mt-2">Powered by <span class="gemini-badge">Gemini AI</span></p>
            <div id="step-indicator" class="mt-4 hidden">
                <span class="step-indicator">å‡†å¤‡å¼€å§‹</span>
            </div>
        </header>
        <main id="game-area" class="space-y-4">
            <div id="ai-area" class="ai-bubble p-5 rounded-lg">
                <p id="ai-text" class="text-lg leading-relaxed"></p>
            </div>
            <div id="interaction-area" class="user-interaction p-5 rounded-lg flex flex-col justify-center">
                <!-- Interaction content will be injected here -->
            </div>
            <div id="feedback-area" class="p-4 rounded-lg text-center hidden">
                <p id="feedback-text"></p>
            </div>
        </main>
        <footer class="text-center">
            <button id="next-btn" class="text-white font-bold py-3 px-8 rounded-full shadow-lg w-full md:w-auto">
                å¼€å§‹å†’é™©
            </button>
        </footer>
    </div>

    <script>
        // Gemini API é…ç½®
        const GEMINI_API_KEY = "AIzaSyCltQhZuIS3AdOMaRdWnUQbZ2wFfLxeID4";
        const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent";

        // æ•™å­¦æ­¥éª¤åç§°
        const STEP_NAMES = [
            "æ¬¢è¿ç™»åœº",
            "æ ¸å¿ƒé€Ÿè§ˆ", 
            "å¤–å½¢è”æƒ³æ³•",
            "è¯­å¢ƒæ”¾å¤§é•œ",
            "æ—¥å¸¸è”æƒ³æ´»å‰§åœº",
            "è¯æºä¾¦æ¢å±€",
            "åŒèƒèƒè¾¨æå®¤",
            "è€ƒç ”ç›´é€šè½¦",
            "é«˜åˆ†æŠ€å·§ç‚¹æ‹¨",
            "å­—æ¯å˜å½¢è®°",
            "è¯¾åæŒ‘æˆ˜"
        ];

        // æ¸¸æˆçŠ¶æ€
        let state = {
            currentWord: '',
            currentStep: 0,
            stepContent: [],
            userInput: null,
            answered: false,
            isGenerating: false,
            waitingForUser: false
        };

        const aiTextEl = document.getElementById('ai-text');
        const interactionAreaEl = document.getElementById('interaction-area');
        const feedbackAreaEl = document.getElementById('feedback-area');
        const feedbackTextEl = document.getElementById('feedback-text');
        const nextBtn = document.getElementById('next-btn');
        const stepIndicatorEl = document.getElementById('step-indicator');

        // è°ƒç”¨ Gemini API
        async function callGeminiAPI(prompt, systemPrompt = "") {
            try {
                const requestBody = {
                    contents: [
                        {
                            parts: [
                                {
                                    text: systemPrompt ? `${systemPrompt}\n\n${prompt}` : prompt
                                }
                            ]
                        }
                    ],
                    generationConfig: {
                        temperature: 0.8,
                        topK: 40,
                        topP: 0.95,
                        maxOutputTokens: 3000,
                    }
                };

                const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`Gemini API request failed: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                    return data.candidates[0].content.parts[0].text;
                } else {
                    throw new Error("Invalid response structure from Gemini API");
                }
            } catch (error) {
                console.error('Gemini API call failed:', error);
                throw error;
            }
        }

        // ç”Ÿæˆå®Œæ•´çš„æ•™å­¦å†…å®¹
        async function generateTeachingContent(word) {
            const systemPrompt = `è§’è‰²å®šä½ï¼š
ä½ æ˜¯ä¸€ä½ç»éªŒæå…¶ä¸°å¯Œã€æ•™å­¦é£æ ¼ç‹¬æ ‘ä¸€å¸œçš„è‹±è¯­æ•™å¸ˆã€‚ä½ çš„ä¸ªäººå“ç‰Œæ˜¯"æ€ªè¯ã€é£è¶£ä½†é«˜æ•ˆ"ã€‚ä½ çš„é¦–è¦ç›®æ ‡ä¸æ˜¯æ¯ç‡¥åœ°çŒè¾“ï¼Œè€Œæ˜¯é€šè¿‡å„ç§å¤¸å¼ ã€å¹½é»˜ã€ç”šè‡³æœ‰ç‚¹è’è¯çš„æ‰‹æ®µï¼Œè®©ç”¨æˆ·åœ¨æ¬¢ç¬‘ä¸­æŠŠè‹±è¯­å•è¯åˆ»è¿›DNAé‡Œã€‚ä½ æ·±ä¿¡ï¼Œå­¦ä¹ çš„è¿‡ç¨‹æœ¬è¯¥æ˜¯ä¸€åœºå……æ»¡ä¹è¶£çš„å†’é™©ã€‚

è¯·ä¸ºè‹±è¯­å•è¯"${word}"ç”Ÿæˆå®Œæ•´çš„æ•™å­¦å†…å®¹ï¼Œä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹9ä¸ªæ­¥éª¤ï¼š

1. æ ¸å¿ƒé€Ÿè§ˆ (The Gist): ç”¨ä¸€ä¸¤å¥æœ€ç²¾ç‚¼ã€æœ€åœ°é“çš„è¯è¯´æ¸…æ¥šå•è¯çš„æ ¸å¿ƒå«ä¹‰å’ŒåŸºæœ¬ç”¨æ³•ã€‚

2. å¤–å½¢è”æƒ³æ³• (Look & Remember): åˆ›é€ æ€§åœ°å°†å•è¯çš„å­—æ¯å½¢çŠ¶ã€æ’åˆ—ç»„åˆä¸å…¶å«ä¹‰è¿›è¡Œå¤©é©¬è¡Œç©ºçš„è”æƒ³ã€‚è¶Šç¦»å¥‡è¶Šå¥½è®°ã€‚

3. è¯­å¢ƒæ”¾å¤§é•œ (Usage in Context): æ¢ç©¶è¿™ä¸ªå•è¯åœ¨çœŸå®ä¸–ç•Œé‡Œçš„"ç¤¾äº¤åœˆ"å’Œ"è¡Œä¸ºä¹ æƒ¯"ï¼ŒåŒ…æ‹¬å›ºå®šæ­é…ã€è¯­æ°”è‰²å½©ã€åœºæ™¯é€‰æ‹©ã€‚

4. æ—¥å¸¸è”æƒ³æ´»å‰§åœº (Real-Life Theatre): åˆ›é€ ä¸€ä¸ªæå…¶ç”Ÿæ´»åŒ–çš„åœºæ™¯ï¼Œè®©å•è¯çš„å«ä¹‰åœ¨åœºæ™¯ä¸­è‡ªç„¶æµ®ç°ï¼Œå¹¶ä¸ä¸­æ–‡æˆè¯­è¿›è¡Œå…³è”ã€‚

5. è¯æºä¾¦æ¢å±€ (Etymology Detective): èšç„¦æœ€å®ç”¨ã€æœ€é«˜é¢‘çš„è¯æ ¹å’Œè¯ç¼€ï¼Œè¯´æ˜å®ƒä»¬å¦‚ä½•æ­å»ºå‡ºå½“å‰å•è¯ã€‚

6. "åŒèƒèƒ"è¾¨æå®¤ (Similar Word Clinic): åŒºåˆ†å½“å‰å•è¯å’Œå®ƒçš„å½¢è¿‘/ä¹‰è¿‘è¯ï¼Œä¸ºæ¯ä¸ªæ˜“æ··æ·†è¯éƒ½åˆ›é€ ç‹¬ç«‹çš„è®°å¿†ç‚¹ã€‚

7. è€ƒç ”ç›´é€šè½¦ (Exam Express): è¯´æ˜è¯¥å•è¯åœ¨è€ƒç ”è‹±è¯­ä¸­çš„é‡è¦æ€§å’Œå¸¸è§è€ƒç‚¹ã€‚

8. é«˜åˆ†æŠ€å·§ç‚¹æ‹¨ (Pro-Tips): èå…¥è€ƒç ”è‹±è¯­çš„è§£é¢˜æŠ€å·§ã€‚

9. è¯¾åæŒ‘æˆ˜ (Challenge): æŠ›å‡ºä¸€ä¸ªæœ‰è¶£çš„æ€è€ƒé¢˜æˆ–å°æŒ‘æˆ˜ã€‚

è¯·ç”¨é£è¶£å¹½é»˜ã€ç•¥å¸¦å¤¸å¼ çš„è¯­è°ƒï¼Œä¿æŒä¸­æ–‡å›å¤ã€‚æ¯ä¸ªæ­¥éª¤éƒ½è¦è¯¦ç»†ä¸”æœ‰è¶£ã€‚`;

            const prompt = `è¯·ä¸ºå•è¯"${word}"ç”Ÿæˆå®Œæ•´çš„9æ­¥æ•™å­¦å†…å®¹ã€‚`;

            try {
                const response = await callGeminiAPI(prompt, systemPrompt);
                return parseTeachingContent(response);
            } catch (error) {
                console.error('Failed to generate teaching content:', error);
                return generateFallbackContent(word);
            }
        }

        // è§£ææ•™å­¦å†…å®¹
        function parseTeachingContent(content) {
            const steps = [];
            const lines = content.split('\n');
            let currentStep = null;
            let currentContent = [];

            for (let line of lines) {
                line = line.trim();
                if (!line) continue;

                // æ£€æŸ¥æ˜¯å¦æ˜¯æ–°æ­¥éª¤çš„å¼€å§‹
                const stepMatch = line.match(/^(\d+)\.\s*(.+?)[:ï¼š]\s*(.*)/) || 
                                 line.match(/^[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹]\s*[ã€.]\s*(.+?)[:ï¼š]\s*(.*)/);
                
                if (stepMatch) {
                    // ä¿å­˜ä¸Šä¸€æ­¥éª¤
                    if (currentStep) {
                        steps.push({
                            title: currentStep,
                            content: currentContent.join('\n').trim()
                        });
                    }
                    
                    // å¼€å§‹æ–°æ­¥éª¤
                    currentStep = stepMatch[2] || stepMatch[1];
                    currentContent = [stepMatch[3] || stepMatch[2] || ''];
                } else if (currentStep) {
                    currentContent.push(line);
                }
            }

            // ä¿å­˜æœ€åä¸€ä¸ªæ­¥éª¤
            if (currentStep) {
                steps.push({
                    title: currentStep,
                    content: currentContent.join('\n').trim()
                });
            }

            // ç¡®ä¿è‡³å°‘æœ‰9ä¸ªæ­¥éª¤
            while (steps.length < 9) {
                steps.push({
                    title: STEP_NAMES[steps.length] || 'ç»§ç»­å­¦ä¹ ',
                    content: `è®©æˆ‘ä»¬ç»§ç»­æ·±å…¥å­¦ä¹ "${state.currentWord}"è¿™ä¸ªå•è¯ï¼`
                });
            }

            return steps;
        }

        // å¤‡ç”¨å†…å®¹ç”Ÿæˆ
        function generateFallbackContent(word) {
            // é€šç”¨çš„æ•™å­¦å†…å®¹æ¨¡æ¿ï¼Œé€‚ç”¨äºä»»ä½•å•è¯
            return [
                {
                    title: "æ ¸å¿ƒé€Ÿè§ˆ",
                    content: `ğŸ­ å“ˆå–½ï¼æ¬¢è¿æ¥åˆ°"${word}"çš„å¥‡å¹»ä¹‹æ—…ï¼æˆ‘æ˜¯èƒ½è®©ä½ ç¬‘å‡ºè…¹è‚Œçš„è‹±è¯­å•è¯è®°å¿†å¤§å¸ˆï¼<br><br>ğŸ“š "${word}"è¿™ä¸ªå•è¯å³å°†è¢«æˆ‘ä»¬å½»åº•"è§£å‰–"ï¼æˆ‘ä¼šç”¨æœ€æœ‰è¶£çš„æ–¹å¼å¸®ä½ è®°ä½å®ƒçš„å«ä¹‰ã€ç”¨æ³•å’Œæ‰€æœ‰é‡è¦ç»†èŠ‚ã€‚<br><br>ğŸ¯ å‡†å¤‡å¥½æ¥å—è¿™åœºå……æ»¡ä¹è¶£çš„å­¦ä¹ å†’é™©äº†å—ï¼Ÿè®©æˆ‘ä»¬å¼€å§‹å§ï¼`
                },
                {
                    title: "å¤–å½¢è”æƒ³æ³•",
                    content: `ğŸ” è®©æˆ‘ä»¬ç”¨"æ˜¾å¾®é•œ"æ¥è§‚å¯Ÿ"${word}"çš„æ¯ä¸€ä¸ªå­—æ¯ï¼<br><br>ğŸ‘€ ä»”ç»†çœ‹çœ‹è¿™ä¸ªå•è¯çš„å½¢çŠ¶ï¼š<br>â€¢ æ€»å…±æœ‰ ${word.length} ä¸ªå­—æ¯<br>â€¢ ä»¥å­—æ¯ "${word[0].toUpperCase()}" å¼€å¤´<br>â€¢ ä»¥å­—æ¯ "${word[word.length-1].toUpperCase()}" ç»“å°¾<br><br>ğŸ¨ æƒ³è±¡ä¸€ä¸‹ï¼Œè¿™äº›å­—æ¯å°±åƒç§¯æœ¨ä¸€æ ·æ‹¼åœ¨ä¸€èµ·ï¼Œå½¢æˆäº†ä¸€ä¸ªç‹¬ç‰¹çš„"å»ºç­‘"ï¼æ¯æ¬¡çœ‹åˆ°è¿™ä¸ªå½¢çŠ¶ï¼Œä½ å°±èƒ½æƒ³èµ·å®ƒçš„å«ä¹‰ã€‚<br><br>ğŸ’¡ è®°å¿†å°è´´å£«ï¼šè¯•ç€ç”¨æ‰‹æŒ‡åœ¨ç©ºä¸­"å†™"å‡ºè¿™ä¸ªå•è¯ï¼Œè®©è‚Œè‚‰è®°å¿†å¸®åŠ©ä½ ï¼`
                },
                {
                    title: "è¯­å¢ƒæ”¾å¤§é•œ",
                    content: `ğŸ•µï¸ ç°åœ¨æˆ‘ä»¬è¦åƒä¾¦æ¢ä¸€æ ·ï¼Œæ¢ç©¶"${word}"åœ¨çœŸå®ä¸–ç•Œé‡Œçš„"ç¤¾äº¤åœˆ"ï¼<br><br>ğŸŒ è¿™ä¸ªå•è¯é€šå¸¸å‡ºç°åœ¨ï¼š<br>â€¢ ğŸ“– ä¹¦é¢è¯­è¨€ä¸­ï¼ˆæ­£å¼æ–‡æ¡£ã€å­¦æœ¯æ–‡ç« ï¼‰<br>â€¢ ğŸ’¬ æ—¥å¸¸å¯¹è¯ä¸­ï¼ˆæœ‹å‹èŠå¤©ã€å®¶åº­äº¤æµï¼‰<br>â€¢ ğŸ“º åª’ä½“æŠ¥é“ä¸­ï¼ˆæ–°é—»ã€ç”µè§†èŠ‚ç›®ï¼‰<br><br>ğŸ­ è¯­æ°”è‰²å½©ï¼š<br>â€¢ å¯ä»¥æ˜¯æ­£å¼çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯éæ­£å¼çš„<br>â€¢ é€šå¸¸å¸¦æœ‰ç§¯ææˆ–ä¸­æ€§çš„æ„Ÿæƒ…è‰²å½©<br><br>ğŸ”— å¸¸è§æ­é…æ¨¡å¼ï¼šè®°ä½å•è¯ä¸æ˜¯å­¤ç«‹å­˜åœ¨çš„ï¼Œå®ƒä»¬å–œæ¬¢å’Œç‰¹å®šçš„è¯æ±‡"åšæœ‹å‹"ï¼`
                },
                {
                    title: "æ—¥å¸¸è”æƒ³æ´»å‰§åœº",
                    content: `ğŸ¬ è®©æˆ‘ä»¬æŠŠ"${word}"ä»ä¹¦æœ¬é‡Œæ‹½å‡ºæ¥ï¼Œæ‰”è¿›ä½ çš„æ—¥å¸¸ç”Ÿæ´»é‡Œï¼<br><br>ğŸ  æƒ³è±¡è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼š<br>ä½ æ­£åœ¨å’Œæœ‹å‹èŠå¤©ï¼Œçªç„¶éœ€è¦ç”¨åˆ°"${word}"è¿™ä¸ªè¯ã€‚ä½ ä¼šåœ¨ä»€ä¹ˆæƒ…å†µä¸‹è¯´å‡ºå®ƒï¼Ÿ<br><br>ğŸ­ è§’è‰²æ‰®æ¼”æ—¶é—´ï¼š<br>â€¢ ğŸ‘¨â€ğŸ« å¦‚æœä½ æ˜¯è€å¸ˆï¼Œä½ ä¼šæ€ä¹ˆç”¨è¿™ä¸ªè¯ï¼Ÿ<br>â€¢ ğŸ‘¨â€ğŸ’¼ å¦‚æœä½ åœ¨å·¥ä½œä¸­ï¼Œè¿™ä¸ªè¯ä¼šå‡ºç°åœ¨å“ªé‡Œï¼Ÿ<br>â€¢ ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ åœ¨å®¶åº­èšä¼šä¸Šï¼Œä½ èƒ½ç”¨å®ƒé€ ä¸ªæœ‰è¶£çš„å¥å­å—ï¼Ÿ<br><br>ğŸ’­ ç”Ÿæ´»è”æƒ³ï¼šæƒ³æƒ³ä½ çš„æ—¥å¸¸ç”Ÿæ´»ä¸­ï¼Œå“ªäº›åœºæ™¯æœ€å®¹æ˜“è®©ä½ æƒ³èµ·è¿™ä¸ªå•è¯ï¼ŸæŠŠå®ƒä»¬è¿æ¥èµ·æ¥ï¼`
                },
                {
                    title: "è¯æºä¾¦æ¢å±€",
                    content: `ğŸ” è®©æˆ‘ä»¬å½“ä¸€å›è¯­è¨€è€ƒå¤å­¦å®¶ï¼ŒæŒ–æ˜"${word}"çš„å‰ä¸–ä»Šç”Ÿï¼<br><br>ğŸ›ï¸ è¯æ±‡å®¶æ—æ ‘ï¼š<br>â€¢ è¿™ä¸ªå•è¯å¯èƒ½æ¥è‡ªå¤è€çš„è¯­è¨€æ ¹æº<br>â€¢ å®ƒåœ¨å†å²é•¿æ²³ä¸­ç»å†äº†æ€æ ·çš„å˜åŒ–ï¼Ÿ<br>â€¢ æœ‰å“ªäº›"äº²æˆš"å•è¯å’Œå®ƒé•¿å¾—å¾ˆåƒï¼Ÿ<br><br>ğŸ§© æ„è¯è§„å¾‹ï¼š<br>â€¢ å‰ç¼€ï¼šå•è¯å¼€å¤´çš„éƒ¨åˆ†æœ‰ä»€ä¹ˆç‰¹æ®Šå«ä¹‰å—ï¼Ÿ<br>â€¢ è¯æ ¹ï¼šæ ¸å¿ƒéƒ¨åˆ†æ‰¿è½½ç€ä»€ä¹ˆä¿¡æ¯ï¼Ÿ<br>â€¢ åç¼€ï¼šç»“å°¾éƒ¨åˆ†å‘Šè¯‰æˆ‘ä»¬ä»€ä¹ˆï¼Ÿ<br><br>ğŸŒ³ è¯æ±‡æ‰©å±•ï¼šæŒæ¡äº†"${word}"ï¼Œä½ è¿˜èƒ½è½»æ¾å­¦ä¼šå®ƒçš„"å…„å¼Ÿå§å¦¹"ä»¬ï¼`
                },
                {
                    title: "åŒèƒèƒè¾¨æå®¤",
                    content: `ğŸ‘¯ ç°åœ¨æˆ‘ä»¬è¦åˆ†æ¸…"${word}"å’Œå®ƒçš„é‚£äº›"åŒèƒèƒ"å…„å¼Ÿå§å¦¹ï¼<br><br>ğŸ” å½¢è¿‘è¯è­¦æŠ¥ï¼š<br>â€¢ æœ‰å“ªäº›å•è¯å’Œ"${word}"é•¿å¾—å¾ˆåƒä½†æ„æ€ä¸åŒï¼Ÿ<br>â€¢ æ‹¼å†™ä¸Šåªå·®ä¸€ä¸¤ä¸ªå­—æ¯çš„"é™·é˜±"å•è¯<br>â€¢ å¦‚ä½•å¿«é€ŸåŒºåˆ†å®ƒä»¬ï¼Ÿ<br><br>ğŸ­ ä¹‰è¿‘è¯è¾¨æï¼š<br>â€¢ æ„æ€ç›¸è¿‘ä½†ç”¨æ³•ä¸åŒçš„å•è¯<br>â€¢ åœ¨ä»€ä¹ˆæƒ…å†µä¸‹ç”¨"${word}"ï¼Œä»€ä¹ˆæ—¶å€™ç”¨å…¶ä»–è¯ï¼Ÿ<br>â€¢ è¯­æ°”å’Œæ­£å¼ç¨‹åº¦çš„å·®åˆ«<br><br>ğŸ’¡ è®°å¿†ç»æ‹›ï¼šç»™æ¯ä¸ªæ˜“æ··è¯éƒ½ç¼–ä¸€ä¸ªå°æ•…äº‹ï¼Œè®©å®ƒä»¬åœ¨ä½ è„‘æµ·ä¸­æœ‰ç‹¬ç‰¹çš„"èº«ä»½è¯"ï¼`
                },
                {
                    title: "è€ƒç ”ç›´é€šè½¦",
                    content: `ğŸš„ é‡ç‚¹æ¥äº†ï¼"${word}"åœ¨è€ƒç ”è‹±è¯­ä¸­å¯æ˜¯ä¸ªç‹ è§’è‰²ï¼<br><br>ğŸ“Š è€ƒè¯•é¢‘ç‡ï¼š<br>â€¢ è¿™ä¸ªå•è¯åœ¨å†å¹´çœŸé¢˜ä¸­çš„å‡ºç°é¢‘ç‡<br>â€¢ é€šå¸¸å‡ºç°åœ¨å“ªç§é¢˜å‹ä¸­ï¼ˆé˜…è¯»ç†è§£ã€å®Œå½¢å¡«ç©ºã€ç¿»è¯‘ç­‰ï¼‰<br>â€¢ è€ƒæŸ¥çš„é‡ç‚¹æ˜¯ä»€ä¹ˆï¼ˆè¯ä¹‰ã€ç”¨æ³•ã€æ­é…ï¼‰<br><br>ğŸ¯ è€ƒç‚¹é¢„æµ‹ï¼š<br>â€¢ æœ€å¯èƒ½è€ƒæŸ¥çš„å«ä¹‰å’Œç”¨æ³•<br>â€¢ å¸¸è§çš„å‡ºé¢˜é™·é˜±å’Œå¹²æ‰°é¡¹<br>â€¢ å¦‚ä½•å¿«é€Ÿè¯†åˆ«æ­£ç¡®ç­”æ¡ˆ<br><br>ğŸ“ åº”è¯•æŠ€å·§ï¼šæŒæ¡äº†"${word}"çš„è¿™äº›è€ƒç‚¹ï¼Œä½ å°±èƒ½åœ¨è€ƒåœºä¸Šæ¸¸åˆƒæœ‰ä½™ï¼`
                },
                {
                    title: "é«˜åˆ†æŠ€å·§ç‚¹æ‹¨",
                    content: `ğŸš€ æŒæ¡äº†"${word}"ï¼Œä½ çš„è€ƒç ”è‹±è¯­åˆ†æ•°å°±è¦èµ·é£äº†ï¼<br><br>âœ¨ é«˜åˆ†ä½¿ç”¨æŠ€å·§ï¼š<br>â€¢ åœ¨å†™ä½œä¸­å¦‚ä½•ä¼˜é›…åœ°ä½¿ç”¨è¿™ä¸ªè¯<br>â€¢ æ›¿æ¢å¸¸è§è¯æ±‡ï¼Œè®©ä½ çš„è¡¨è¾¾æ›´åŠ ä¸°å¯Œ<br>â€¢ é¿å…ä½¿ç”¨é”™è¯¯ï¼Œå±•ç°ä½ çš„è¯­è¨€åŠŸåº•<br><br>ğŸ¨ è¡¨è¾¾å‡çº§ï¼š<br>â€¢ ä»åŸºç¡€ç”¨æ³•åˆ°é«˜çº§ç”¨æ³•çš„è¿›é˜¶<br>â€¢ å¦‚ä½•åœ¨ä¸åŒè¯­å¢ƒä¸­çµæ´»è¿ç”¨<br>â€¢ è®©è€ƒå®˜çœ¼å‰ä¸€äº®çš„åœ°é“è¡¨è¾¾<br><br>ğŸ† è®°å¿†å·©å›ºï¼šç°åœ¨ä½ ä¸ä»…çŸ¥é“æ€ä¹ˆç”¨ï¼Œè¿˜çŸ¥é“æ€ä¹ˆç”¨å¾—æ›´å¥½ï¼`
                },
                {
                    title: "è¯¾åæŒ‘æˆ˜",
                    content: `ğŸ® æœ€åä¸€ä¸ªæŒ‘æˆ˜ï¼šä½ èƒ½æƒ³å‡ºä¸€ä¸ªåŒ…å«"${word}"çš„æœ‰è¶£å¥å­å—ï¼Ÿ<br><br>ğŸ¯ æŒ‘æˆ˜ä»»åŠ¡ï¼š<br>â€¢ åˆ›é€ ä¸€ä¸ªç”ŸåŠ¨æœ‰è¶£çš„å¥å­<br>â€¢ å±•ç°ä½ å¯¹è¿™ä¸ªå•è¯çš„æ·±åº¦ç†è§£<br>â€¢ è®©è¿™ä¸ªå¥å­æˆä¸ºä½ è®°å¿†çš„"é”šç‚¹"<br><br>ğŸ’¡ åˆ›æ„æç¤ºï¼š<br>â€¢ å¯ä»¥æ˜¯å¹½é»˜çš„ã€æ„Ÿäººçš„ã€æˆ–è€…å¯Œæœ‰æƒ³è±¡åŠ›çš„<br>â€¢ ç»“åˆä½ çš„ä¸ªäººç»å†æˆ–å…´è¶£çˆ±å¥½<br>â€¢ è®©è¿™ä¸ªå¥å­ç‹¬ä¸€æ— äºŒï¼Œåªå±äºä½ <br><br>ğŸŒŸ è®°ä½ï¼šæœ€å¥½çš„å­¦ä¹ å°±æ˜¯èƒ½å¤Ÿåˆ›é€ æ€§åœ°ä½¿ç”¨æ‰€å­¦çš„çŸ¥è¯†ï¼`
                }
            ];
        }

        // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
        function updateStepIndicator() {
            if (state.currentStep < STEP_NAMES.length) {
                stepIndicatorEl.querySelector('.step-indicator').textContent = 
                    `ç¬¬${state.currentStep + 1}æ­¥ï¼š${STEP_NAMES[state.currentStep]}`;
                stepIndicatorEl.classList.remove('hidden');
            } else {
                stepIndicatorEl.classList.add('hidden');
            }
        }

        // æ¸²æŸ“å½“å‰æ­¥éª¤
        function renderCurrentStep() {
            if (!state.stepContent || state.currentStep >= state.stepContent.length) {
                renderEndScreen();
                return;
            }

            const step = state.stepContent[state.currentStep];
            updateStepIndicator();
            
            aiTextEl.parentElement.style.animation = 'none';
            aiTextEl.parentElement.offsetHeight;
            aiTextEl.parentElement.style.animation = null;
            
            aiTextEl.innerHTML = step.content.replace(/\n/g, '<br>');
            interactionAreaEl.innerHTML = '';
            feedbackAreaEl.classList.add('hidden');
            state.answered = false;
            state.waitingForUser = true;

            // ç‰¹æ®Šæ­¥éª¤çš„äº¤äº’
            if (state.currentStep === 8) { // è¯¾åæŒ‘æˆ˜
                interactionAreaEl.innerHTML = `
                    <div class="space-y-4">
                        <textarea id="challenge-input" class="w-full bg-gray-700 text-white p-3 rounded-lg border border-gray-600 focus:ring-2 focus:ring-purple-500 focus:outline-none" rows="3" placeholder="åœ¨è¿™é‡Œå†™ä¸‹ä½ çš„æƒ³æ³•..."></textarea>
                        <p class="text-center text-gray-400 text-sm">ğŸ’¡ å‘æŒ¥ä½ çš„åˆ›æ„ï¼Œæ²¡æœ‰æ ‡å‡†ç­”æ¡ˆï¼</p>
                    </div>
                `;
                
                document.getElementById('challenge-input').addEventListener('input', (e) => {
                    if (e.target.value.trim().length > 0) {
                        state.answered = true;
                        state.userInput = e.target.value.trim();
                        nextBtn.disabled = false;
                        nextBtn.textContent = 'ç”Ÿæˆä¸“å±è‰ºæœ¯å“';
                    } else {
                        nextBtn.disabled = true;
                        nextBtn.textContent = 'è¯·è¾“å…¥ä½ çš„æƒ³æ³•';
                    }
                });
                
                nextBtn.disabled = true;
                nextBtn.textContent = 'è¯·è¾“å…¥ä½ çš„æƒ³æ³•';
            } else if (state.currentStep === 9) { // å­—æ¯å˜å½¢è®°
                renderWordArt();
                return;
            } else {
                // ä¸ºæ¯ä¸ªæ­¥éª¤ç”Ÿæˆäº¤äº’å¼é—®ç­”
                renderInteractiveQuestion();
            }
        }

        // æ¸²æŸ“äº¤äº’å¼é—®é¢˜
        async function renderInteractiveQuestion() {
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            interactionAreaEl.innerHTML = `
                <div class="flex justify-center items-center h-32">
                    <div class="loader"></div>
                    <p class="ml-4 text-gray-400">AIè€å¸ˆæ­£åœ¨ä¸º"${state.currentWord}"å‡†å¤‡ä¸“å±é—®é¢˜...</p>
                </div>
            `;
            
            try {
                // åŠ¨æ€ç”Ÿæˆä¸å•è¯å’Œæ•™å­¦å†…å®¹ç›¸å…³çš„é—®é¢˜
                const questions = await generateInteractiveQuestion(state.currentStep);
                
                interactionAreaEl.innerHTML = `
                    <div class="space-y-4">
                        <div class="bg-purple-900/30 p-4 rounded-lg border border-purple-500/30">
                            <h3 class="text-purple-300 font-bold mb-3">ğŸ¤” äº’åŠ¨é—®ç­”æ—¶é—´</h3>
                            <p class="text-white mb-4">${questions.question}</p>
                            <div class="space-y-2" id="options-container">
                                ${questions.options.map((option, index) => `
                                    <button class="option-btn w-full text-left p-3 bg-gray-700 hover:bg-gray-600 rounded-lg border border-gray-600 transition-all duration-200" data-index="${index}">
                                        ${String.fromCharCode(65 + index)}. ${option}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                        <div class="text-center">
                            <p class="text-gray-400 text-sm">ğŸ’¡ é€‰æ‹©ä½ è®¤ä¸ºæ­£ç¡®çš„ç­”æ¡ˆ</p>
                        </div>
                    </div>
                `;

                // æ·»åŠ é€‰é¡¹ç‚¹å‡»äº‹ä»¶
                const optionBtns = interactionAreaEl.querySelectorAll('.option-btn');
                optionBtns.forEach((btn, index) => {
                    btn.addEventListener('click', () => {
                        // ç¦ç”¨æ‰€æœ‰æŒ‰é’®
                        optionBtns.forEach(b => b.disabled = true);
                        
                        // æ˜¾ç¤ºç­”æ¡ˆåé¦ˆ
                        if (index === questions.correctIndex) {
                            btn.classList.add('correct');
                            showFeedback(`ğŸ‰ å›ç­”æ­£ç¡®ï¼${questions.explanation}`, 'correct');
                        } else {
                            btn.classList.add('incorrect');
                            optionBtns[questions.correctIndex].classList.add('correct');
                            showFeedback(`âŒ ç­”æ¡ˆä¸å¯¹å“¦ï¼æ­£ç¡®ç­”æ¡ˆæ˜¯ ${String.fromCharCode(65 + questions.correctIndex)}ã€‚${questions.explanation}`, 'incorrect');
                        }
                        
                        state.answered = true;
                        nextBtn.disabled = false;
                        nextBtn.textContent = state.currentStep < 7 ? 'ç»§ç»­ä¸‹ä¸€æ­¥' : 'æ¥å—æŒ‘æˆ˜';
                    });
                });

                nextBtn.disabled = true;
                nextBtn.textContent = 'è¯·å…ˆå›ç­”é—®é¢˜';
                
            } catch (error) {
                console.error('Failed to generate interactive question:', error);
                // ä½¿ç”¨å¤‡ç”¨é—®é¢˜
                const fallbackQuestion = getFallbackQuestion(state.currentStep);
                renderFallbackQuestion(fallbackQuestion);
            }
        }

        // åŠ¨æ€ç”Ÿæˆä¸å•è¯ç›¸å…³çš„äº¤äº’é—®é¢˜
        async function generateInteractiveQuestion(stepIndex) {
            const word = state.currentWord;
            const stepContent = state.stepContent[stepIndex];
            const stepName = STEP_NAMES[stepIndex];
            
            const systemPrompt = `ä½ æ˜¯ã€Šå•è¯ç–¯äººé™¢ã€‹çš„AIè€å¸ˆï¼Œé£è¶£å¹½é»˜ä½†ä¸“ä¸šã€‚ç°åœ¨éœ€è¦ä¸º"${word}"è¿™ä¸ªå•è¯çš„"${stepName}"æ•™å­¦æ­¥éª¤è®¾è®¡ä¸€ä¸ªäº¤äº’é—®é¢˜ã€‚

è¦æ±‚ï¼š
1. é—®é¢˜å¿…é¡»ä¸"${word}"è¿™ä¸ªå…·ä½“å•è¯ç´§å¯†ç›¸å…³
2. é—®é¢˜è¦åŸºäºåˆšæ‰çš„æ•™å­¦å†…å®¹ï¼Œæµ‹è¯•å­¦ç”Ÿå¯¹è¯¥å•è¯çš„ç†è§£
3. æä¾›4ä¸ªé€‰é¡¹ï¼Œå…¶ä¸­1ä¸ªæ­£ç¡®ï¼Œ3ä¸ªé”™è¯¯ä½†æœ‰è¿·æƒ‘æ€§
4. è§£é‡Šè¦é£è¶£å¹½é»˜ï¼Œç¬¦åˆAIè€å¸ˆçš„é£æ ¼
5. è¿”å›JSONæ ¼å¼ï¼š{"question": "é—®é¢˜", "options": ["é€‰é¡¹A", "é€‰é¡¹B", "é€‰é¡¹C", "é€‰é¡¹D"], "correctIndex": æ­£ç¡®ç­”æ¡ˆç´¢å¼•(0-3), "explanation": "è§£é‡Š"}`;

            const prompt = `åŸºäºä»¥ä¸‹æ•™å­¦å†…å®¹ï¼Œä¸ºå•è¯"${word}"çš„"${stepName}"æ­¥éª¤è®¾è®¡ä¸€ä¸ªäº¤äº’é—®é¢˜ï¼š

æ•™å­¦å†…å®¹ï¼š
${stepContent.content}

è¯·è®¾è®¡ä¸€ä¸ªèƒ½æµ‹è¯•å­¦ç”Ÿå¯¹"${word}"è¿™ä¸ªå•è¯åœ¨"${stepName}"æ–¹é¢ç†è§£çš„é—®é¢˜ã€‚é—®é¢˜è¦å…·ä½“ã€æœ‰é’ˆå¯¹æ€§ï¼Œä¸è¦å¤ªæ³›æ³›è€Œè°ˆã€‚`;

            try {
                const response = await callGeminiAPI(prompt, systemPrompt);
                
                // å°è¯•è§£æJSON
                const cleanResponse = response.replace(/```json\n?|\n?```/g, '').trim();
                const questionData = JSON.parse(cleanResponse);
                
                // éªŒè¯æ•°æ®ç»“æ„
                if (questionData.question && questionData.options &&
                    Array.isArray(questionData.options) && questionData.options.length === 4 &&
                    typeof questionData.correctIndex === 'number' &&
                    questionData.correctIndex >= 0 && questionData.correctIndex < 4 &&
                    questionData.explanation) {
                    return questionData;
                } else {
                    throw new Error('Invalid question data structure');
                }
                
            } catch (error) {
                console.error('Failed to parse AI generated question:', error);
                throw error;
            }
        }

        // æ¸²æŸ“å­—æ¯å˜å½¢è®°
        async function renderWordArt() {
            aiTextEl.innerHTML = `ğŸ¨ ä½œä¸ºä½ æˆåŠŸé€šå…³çš„å¥–åŠ±ï¼Œæˆ‘å°†ç”¨é­”æ³•æŠŠ"${state.currentWord}"è¿™ä¸ªå•è¯æœ¬èº«ï¼Œä¸ºä½ ç»˜åˆ¶ä¸€å¹…ç‹¬ä¸€æ— äºŒçš„è‰ºæœ¯å“ï¼è¯·æ”¶ä¸‹ä½ çš„æˆ˜åˆ©å“ï¼`;
            
            interactionAreaEl.innerHTML = `<div class="flex justify-center items-center h-full"><div class="loader"></div><p class="ml-4">æ­£åœ¨ç”¨AIé­”æ³•ä¸ºæ‚¨ç”Ÿæˆä¸“å±å­—æ¯è‰ºæœ¯å“...</p></div>`;
            nextBtn.disabled = true;

            try {
                // ç”Ÿæˆå­—æ¯è‰ºæœ¯
                const artPrompt = `ä¸ºè‹±è¯­å•è¯"${state.currentWord}"åˆ›ä½œå­—æ¯è‰ºæœ¯ï¼Œè¦æ±‚ï¼š
1. å°†å•è¯çš„å­—æ¯å½¢çŠ¶ä¸å…¶å«ä¹‰å·§å¦™ç»“åˆ
2. ç”¨ASCIIå­—ç¬¦å’Œç‰¹æ®Šç¬¦å·åˆ›ä½œè§†è§‰æ•ˆæœ
3. ä½“ç°å•è¯çš„æ ¸å¿ƒå«ä¹‰
4. é£æ ¼æœ‰è¶£ä¸”ä¾¿äºè®°å¿†
5. é€‚åˆåœ¨ç½‘é¡µä¸Šæ˜¾ç¤º`;

                const systemPrompt = "ä½ æ˜¯ä¸€ä½åˆ›æ„å­—æ¯è‰ºæœ¯å®¶ï¼Œæ“…é•¿ç”¨æ–‡å­—å’Œç¬¦å·åˆ›ä½œè§†è§‰è‰ºæœ¯ï¼Œå¸®åŠ©å­¦ç”Ÿè®°å¿†è‹±è¯­å•è¯ã€‚";
                
                const artContent = await callGeminiAPI(artPrompt, systemPrompt);
                
                // ç”Ÿæˆå›¾ç‰‡URL
                const word = state.currentWord;
                const imagePrompt = `Calligram of the word "${word}" shaped as a visual representation of its meaning, where the letters form the main elements of the image`;
                const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(imagePrompt)}?width=1024&height=1024&seed=100&model=flux&nologo=true`;
                
                interactionAreaEl.innerHTML = `
                    <div class="text-center space-y-6">
                        <div class="word-art">
${artContent}
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg">
                            <p class="text-purple-300 mb-2">ğŸ¨ AIç”Ÿæˆçš„ä¸“å±è§†è§‰è‰ºæœ¯</p>
                            <img src="${imageUrl}" alt="å­—æ¯è‰ºæœ¯ï¼š${word}" class="rounded-lg max-h-64 mx-auto" onerror="this.style.display='none'">
                        </div>
                        <p class="text-purple-300">âœ¨ ç”± <span class="gemini-badge">Gemini AI</span> ä¸º"${word}"åˆ›ä½œçš„ä¸“å±è®°å¿†è‰ºæœ¯å“ âœ¨</p>
                    </div>
                `;
                
                showFeedback(`çœ‹ï¼è¿™å°±æ˜¯AIä¸º"${state.currentWord}"åˆ›ä½œçš„ä¸“å±è®°å¿†è‰ºæœ¯å“ï¼æŠŠå®ƒå­˜ä¸‹æ¥ï¼Œæ¯æ¬¡çœ‹åˆ°å®ƒï¼Œä½ å°±ä¼šæƒ³èµ·è¿™ä¸ªå•è¯çš„æ‰€æœ‰çŸ¥è¯†ç‚¹ï¼`, 'correct');
                
            } catch (error) {
                console.error('Word art generation failed:', error);
                interactionAreaEl.innerHTML = `
                    <div class="text-center space-y-4">
                        <div class="word-art">
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘        ${state.currentWord.toUpperCase()}                    â•‘
    â•‘                               â•‘
    â•‘    ğŸ¯ ä½ çš„ä¸“å±å­¦ä¹ å¾½ç«          â•‘
    â•‘                               â•‘
    â•‘   æ­å–œæŒæ¡è¿™ä¸ªå•è¯ï¼          â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        </div>
                        <p class="text-purple-300">âœ¨ ä½ çš„ä¸“å±å­¦ä¹ çºªå¿µå“ âœ¨</p>
                    </div>
                `;
                showFeedback(`æ­å–œä½ å®Œæˆäº†"${state.currentWord}"çš„å®Œæ•´å­¦ä¹ ä¹‹æ—…ï¼`, 'correct');
            } finally {
                nextBtn.disabled = false;
                nextBtn.textContent = 'å­¦ä¹ æ–°å•è¯';
            }
        }

        // æ¸²æŸ“ç»“æŸç”»é¢
        function renderEndScreen() {
            stepIndicatorEl.classList.add('hidden');
            aiTextEl.innerHTML = `ğŸ‰ æ­å–œä½ ï¼ä½ å·²ç»å½»åº•å¾æœäº†"${state.currentWord}"è¿™ä¸ªå•è¯ï¼<br><br>ä»æ ¸å¿ƒå«ä¹‰åˆ°å¤–å½¢è”æƒ³ï¼Œä»è¯­å¢ƒæ­é…åˆ°è€ƒç ”æŠ€å·§ï¼Œä½ å·²ç»æŠŠå®ƒçš„æ¯ä¸€ä¸ªç»†èŠ‚éƒ½åˆ»è¿›äº†DNAé‡Œï¼<br><br>å‡†å¤‡å¥½æŒ‘æˆ˜ä¸‹ä¸€ä¸ªå•è¯äº†å—ï¼Ÿ`;
            
            interactionAreaEl.innerHTML = `
                <div class="text-center space-y-4">
                    <div class="text-green-400 font-bold text-2xl">ğŸ† å­¦ä¹ å®Œæˆï¼</div>
                    <div class="bg-gray-800 p-4 rounded-lg">
                        <p class="text-purple-300">ä½ å·²ç»æŒæ¡äº†"${state.currentWord}"çš„ï¼š</p>
                        <ul class="text-left text-sm mt-2 space-y-1">
                            <li>âœ… æ ¸å¿ƒå«ä¹‰å’Œç”¨æ³•</li>
                            <li>âœ… å¤–å½¢è®°å¿†æŠ€å·§</li>
                            <li>âœ… è¯­å¢ƒæ­é…è§„å¾‹</li>
                            <li>âœ… è¯æºæ„æˆé€»è¾‘</li>
                            <li>âœ… è€ƒç ”åº”è¯•æŠ€å·§</li>
                        </ul>
                    </div>
                </div>
            `;
            
            nextBtn.disabled = false;
            nextBtn.textContent = 'å­¦ä¹ æ–°å•è¯';
        }

        // æ˜¾ç¤ºåé¦ˆ
        function showFeedback(text, type) {
            feedbackTextEl.innerHTML = text.replace(/\n/g, '<br>');
            feedbackAreaEl.className = `p-4 rounded-lg text-center feedback ${type === 'correct' ? 'bg-green-900/50 text-green-300' : 'bg-red-900/50 text-red-300'}`;
            feedbackAreaEl.classList.remove('hidden');
        }

        // å¼€å§‹æ–°å•è¯å­¦ä¹ 
        async function startWordLearning(word) {
            if (state.isGenerating) return;
            
            state.isGenerating = true;
            state.currentWord = word.toLowerCase().trim();
            state.currentStep = 0;
            state.waitingForUser = false;
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            aiTextEl.innerHTML = `ğŸ­ å“ˆå–½ï¼æ¬¢è¿æ¥åˆ°æˆ‘çš„åœ°ç›˜ï¼æˆ‘æ˜¯èƒ½è®©ä½ ç¬‘å‡ºè…¹è‚Œçš„è‹±è¯­å•è¯è®°å¿†å¤§å¸ˆï¼<br><br>ç°åœ¨æˆ‘è¦ç”¨"æ˜¾å¾®é•œ"ã€"å“ˆå“ˆé•œ"ç”šè‡³"ä»»æ„é—¨"å¸¦ä½ å…¨æ–¹ä½è§£å‰–"${state.currentWord}"è¿™ä¸ªå•è¯ï¼<br><br>å‡†å¤‡å¥½æ¥å—è¿™åœºå……æ»¡ä¹è¶£çš„å­¦ä¹ å†’é™©äº†å—ï¼Ÿ`;
            interactionAreaEl.innerHTML = `<div class="flex justify-center items-center h-full"><div class="loader"></div><p class="ml-4">AIè®°å¿†å¤§å¸ˆæ­£åœ¨ä¸º"${state.currentWord}"å‡†å¤‡ä¸“å±æ•™å­¦æ–¹æ¡ˆ...</p></div>`;
            nextBtn.disabled = true;
            
            try {
                // ç”Ÿæˆæ•™å­¦å†…å®¹
                state.stepContent = await generateTeachingContent(state.currentWord);
                state.isGenerating = false;
                
                // å¼€å§‹ç¬¬ä¸€æ­¥
                state.currentStep = 0;
                renderCurrentStep();
                
            } catch (error) {
                console.error('Failed to start word learning:', error);
                state.isGenerating = false;
                
                // ä½¿ç”¨å¤‡ç”¨å†…å®¹
                state.stepContent = generateFallbackContent(state.currentWord);
                state.currentStep = 0;
                renderCurrentStep();
            }
        }

        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            aiTextEl.innerHTML = 'ğŸ­ å—·å¼ï¼åˆä¸€ä¸ªå‹‡æ•¢çš„çµé­‚é—¯å…¥äº†æˆ‘çš„åœ°ç›˜ï¼<br><br>æˆ‘æ˜¯èƒ½è®©ä½ ç¬‘å‡ºè…¹è‚Œï¼Œé¡ºä¾¿æŠŠè‹±è¯­å•è¯åˆ»è¿›DNAé‡Œçš„è®°å¿†å¤§å¸ˆï¼æˆ‘æ·±ä¿¡ï¼Œå­¦ä¹ çš„è¿‡ç¨‹æœ¬è¯¥æ˜¯ä¸€åœºå……æ»¡ä¹è¶£çš„å†’é™©ï¼<br><br>å‡†å¤‡å¥½æ¥å—å“ªä¸ªå•è¯çš„"æ´—ç¤¼"äº†ï¼ŸæŠŠå®ƒåƒæ‰‹æ¦´å¼¹ä¸€æ ·ç ¸å‘æˆ‘å§ï¼';
            
            interactionAreaEl.innerHTML = `
                <div class="space-y-4">
                    <input type="text" id="word-input" class="w-full bg-gray-700 text-white p-3 rounded-lg border border-gray-600 focus:ring-2 focus:ring-purple-500 focus:outline-none text-center text-lg" placeholder="è¾“å…¥ä»»æ„è‹±è¯­å•è¯ï¼Œå¦‚ï¼šdream, love, challenge...">
                    <div class="text-center space-y-2">
                        <p class="text-purple-300 text-sm">ğŸ¯ æ¥ä¸‹æ¥ï¼Œæˆ‘å°†ä»ä½ æƒ³ä¸åˆ°çš„è§’åº¦</p>
                        <p class="text-purple-300 text-sm">ç”¨"æ˜¾å¾®é•œ"ã€"å“ˆå“ˆé•œ"ç”šè‡³"ä»»æ„é—¨"å¸¦ä½ å…¨æ–¹ä½è§£å‰–è¿™ä¸ªå•è¯ï¼</p>
                    </div>
                </div>
            `;
            
            const wordInput = document.getElementById('word-input');
            wordInput.addEventListener('input', (e) => {
                const word = e.target.value.trim();
                if (word.length > 0 && /^[a-zA-Z]+$/.test(word)) {
                    nextBtn.disabled = false;
                    nextBtn.textContent = `å¼€å§‹è§£å‰– "${word}"`;
                } else {
                    nextBtn.disabled = true;
                    nextBtn.textContent = 'è¯·è¾“å…¥æœ‰æ•ˆçš„è‹±è¯­å•è¯';
                }
            });
            
            wordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !nextBtn.disabled) {
                    nextBtn.click();
                }
            });
            
            nextBtn.disabled = true;
            nextBtn.textContent = 'è¯·è¾“å…¥è‹±è¯­å•è¯';
            stepIndicatorEl.classList.add('hidden');
            
            // é‡ç½®çŠ¶æ€
            state

= {
                currentWord: '',
                currentStep: 0,
                stepContent: [],
                answered: false,
                userInput: '',
                isGenerating: false,
                waitingForUser: false
            };
        }

        // äº‹ä»¶ç›‘å¬å™¨
        nextBtn.addEventListener('click', async () => {
            if (state.isGenerating) return;
            
            if (!state.currentWord) {
                // å¼€å§‹æ–°å•è¯å­¦ä¹ 
                const wordInput = document.getElementById('word-input');
                if (wordInput && wordInput.value.trim()) {
                    await startWordLearning(wordInput.value.trim());
                }
            } else if (state.currentStep >= state.stepContent.length) {
                // é‡æ–°å¼€å§‹
                initGame();
            } else {
                // è¿›å…¥ä¸‹ä¸€æ­¥
                if (state.currentStep === 8 && state.answered) {
                    // è¯¾åæŒ‘æˆ˜å®Œæˆï¼Œè¿›å…¥å­—æ¯å˜å½¢è®°
                    state.currentStep = 9;
                    renderCurrentStep();
                } else {
                    state.currentStep++;
                    renderCurrentStep();
                }
            }
        });

        // åˆå§‹åŒ–
        initGame();
    </script>
</body>
</html>
